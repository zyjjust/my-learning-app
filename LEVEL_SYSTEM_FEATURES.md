# 等级系统和特效功能说明

## ✅ 已实现的功能

### 1. 等级系统

#### 等级计算
- **累计积分**：根据 `total_xp`（累计积分）计算等级
- **等级公式**：每 100 积分升一级
  - 等级 = Math.floor(累计积分 / 100) + 1
  - 当前等级进度 = 累计积分 % 100

#### 称号系统
根据等级自动获得称号：

| 等级范围 | 称号 |
|---------|------|
| 1-4 | 学习新星 ⭐ |
| 5-9 | 进步之星 ⭐⭐ |
| 10-14 | 学习达人 ⭐⭐⭐ |
| 15-19 | 智慧大师 ⭐⭐⭐⭐ |
| 20+ | 知识王者 👑 |

#### 数据库字段
需要在 Supabase 中添加 `total_xp` 字段：
```sql
ALTER TABLE public.users 
ADD COLUMN IF NOT EXISTS total_xp INTEGER DEFAULT 0;
```

运行 `database/add-total-xp-field.sql` 脚本即可。

---

### 2. 视觉特效 - 五彩纸屑（Confetti）

#### 触发时机
- ✅ 完成任务时自动触发
- ✅ 升级时额外触发一次

#### 特效特点
- 使用 `canvas-confetti` 库
- 多彩纸屑：金色、红色、青色、蓝色、橙色、绿色
- 持续 3 秒
- 从屏幕上方随机位置飘落

---

### 3. 音效反馈

#### 音效类型

1. **完成任务音效** (`complete`)
   - 音调：800Hz → 1000Hz
   - 时长：0.3 秒
   - 描述：叮咚声

2. **金币音效** (`coin`)
   - 音调：600Hz → 800Hz
   - 时长：0.2 秒
   - 触发：完成任务、兑换奖励时

3. **升级音效** (`levelup`)
   - 音调：400Hz → 600Hz → 800Hz（上升音调）
   - 时长：0.4 秒
   - 触发：升级时

#### 技术实现
- 使用 Web Audio API 生成音效
- 无需外部音频文件
- 自动处理浏览器兼容性

---

### 4. UI 升级 - 等级进度条

#### 显示内容
在头部左侧卡片中显示：

1. **等级信息**
   - 等级数字（如：等级 5）
   - 当前称号（如：进步之星）

2. **积分信息**
   - 累计积分总数
   - 当前等级进度（如：45/100）

3. **进度条**
   - 渐变色彩：黄色 → 橙色 → 黄色
   - 实时更新进度
   - 平滑动画过渡

#### 视觉效果
- Material Design 风格卡片
- 清晰的层次结构
- 响应式设计

---

## 📋 使用说明

### 完成任务流程

1. **点击任务完成按钮**
   - 任务状态切换为已完成
   - 立即触发：
     - ✅ 五彩纸屑特效
     - ✅ 完成任务音效
     - ✅ 金币音效

2. **积分和等级更新**
   - 累计积分增加（任务积分值）
   - 金币增加（任务积分值）
   - 自动计算新等级和称号
   - 进度条实时更新

3. **升级检测**
   - 如果累计积分达到新等级阈值：
     - ✅ 触发升级音效
     - ✅ 再次触发五彩纸屑特效
     - ✅ 显示升级提示弹窗

### 兑换奖励流程

1. **点击兑换按钮**
   - 扣除相应金币
   - 触发金币音效
   - 更新数据库

---

## 🔧 技术细节

### 状态管理
```typescript
const [level, setLevel] = useState(1)           // 当前等级
const [currentLevelXP, setCurrentLevelXP] = useState(0)  // 当前等级进度
const [totalXP, setTotalXP] = useState(0)       // 累计积分
const [title, setTitle] = useState("学习新星")   // 当前称号
```

### 等级计算函数
```typescript
const calculateLevelAndTitle = (totalXP: number) => {
  const calculatedLevel = Math.floor(totalXP / 100) + 1
  const currentXP = totalXP % 100
  // ... 计算称号
  return { level, title, currentXP }
}
```

### 音效生成
```typescript
const playSound = (soundType: 'complete' | 'coin' | 'levelup') => {
  // 使用 Web Audio API 生成音效
}
```

### 特效触发
```typescript
const triggerConfetti = () => {
  // 使用 canvas-confetti 库
}
```

---

## 📊 数据库更新

### 新增字段
- `total_xp` (INTEGER) - 累计积分

### 更新逻辑
完成任务时更新：
- `total_xp` - 累计积分
- `level` - 计算后的等级
- `current_xp` - 当前等级进度
- `gold_coins` - 金币

---

## 🎨 UI 展示

### 等级卡片布局
```
┌─────────────────────────┐
│ 🏆 等级 5                │
│ 进步之星                 │
│                         │
│ 累计积分: 450            │
│ 45/100                  │
│ [████████░░] 45%        │
└─────────────────────────┘
```

---

## 🚀 未来改进建议

- [ ] 添加更多称号等级
- [ ] 添加等级奖励系统
- [ ] 添加音效开关设置
- [ ] 添加特效强度设置
- [ ] 添加等级历史记录
- [ ] 添加排行榜功能

---

## ⚠️ 注意事项

1. **浏览器兼容性**
   - 音效需要用户交互后才能播放（浏览器安全策略）
   - 首次需要用户点击页面任意位置激活音频上下文

2. **数据库迁移**
   - 运行 `database/add-total-xp-field.sql` 添加字段
   - 已有用户的 `total_xp` 默认为 0

3. **性能考虑**
   - Confetti 特效会消耗一定性能
   - 音效使用轻量级 Web Audio API

---

**所有功能已实现并测试通过！** 🎉





